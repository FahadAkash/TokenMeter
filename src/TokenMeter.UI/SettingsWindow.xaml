<Window x:Class="TokenMeter.UI.SettingsWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        xmlns:converters="clr-namespace:TokenMeter.UI.Converters"
        Title="Settings &amp; Authentication" Width="600" Height="550"
        WindowStartupLocation="CenterOwner"
        Background="{DynamicResource CatBase}"
        FontFamily="Segoe UI Variable Text, Segoe UI">

    <Window.Resources>
        <!-- Converter now comes from App.xaml -->
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="60"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Premium Header Area -->
        <Border Grid.Row="0" Background="{DynamicResource CatMantle}" BorderBrush="{DynamicResource CatSurface0}" BorderThickness="0,0,0,1">
            <Grid Margin="24,0">
                <StackPanel VerticalAlignment="Center">
                    <TextBlock Text="Settings &amp; Authentication" FontWeight="Bold" Foreground="{DynamicResource CatText}" FontSize="16"/>
                    <TextBlock Text="Configure your AI provider tokens" Foreground="{DynamicResource CatSubtext}" FontSize="11"/>
                </StackPanel>
                <Button HorizontalAlignment="Right" VerticalAlignment="Center" 
                        Background="Transparent" BorderThickness="0" Width="32" Height="32" 
                        Click="CloseButton_Click" Content="âœ•" Foreground="{DynamicResource CatSubtext}"
                        FontSize="18" Padding="0"/>
            </Grid>
        </Border>

        <!-- Main Settings Content -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
            <Border Padding="24">
                <StackPanel>
                    <TextBlock Text="Manual Token Entry" Style="{DynamicResource HeaderStyle}" FontSize="18" Margin="0,0,0,4"/>
                    <TextBlock Text="Paste browser cookies or API tokens below. Use the Auto-Detect button below to try gathering them automatically." 
                               Style="{DynamicResource SubtextStyle}" Margin="0,0,0,24" TextWrapping="Wrap"/>

                    <!-- Claude -->
                    <materialDesign:Card Padding="24" UniformCornerRadius="12" Background="{DynamicResource CatSurface0}" Margin="0,0,0,20">
                        <StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,16">
                                <materialDesign:PackIcon Kind="MoonWaningCrescent" Foreground="{DynamicResource CatMauve}" VerticalAlignment="Center" Width="24" Height="24"/>
                                <TextBlock Text="Anthropic Claude" Style="{DynamicResource HeaderStyle}" FontSize="18" Margin="12,0,0,0" VerticalAlignment="Center"/>
                            </StackPanel>
                            
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,16">
                                <Button Content="Auto-Detect Session" Command="{Binding AutoDetectClaudeCommand}" 
                                        Style="{DynamicResource AuthActionButton}" Foreground="{DynamicResource CatMauve}"
                                        ToolTip="Scans browser cookies specifically for claude.ai"/>
                                <Button Content="Authorize via Browser (OAuth Flow)" Command="{Binding OpenClaudeUrlCommand}" 
                                        Style="{DynamicResource AuthActionButton}" Foreground="{DynamicResource CatSubtext}" 
                                        Margin="12,0,0,0"/>
                            </StackPanel>

                            <TextBox Style="{DynamicResource PremiumTextBox}"
                                     materialDesign:HintAssist.Hint="Session Key (sessionKey=...)" 
                                     Text="{Binding ClaudeCookie}" 
                                     materialDesign:TextFieldAssist.UnderlineBrush="{DynamicResource CatMauve}"/>
                        </StackPanel>
                    </materialDesign:Card>


                    <!-- Cursor -->
                    <materialDesign:Card Padding="24" UniformCornerRadius="12" Background="{DynamicResource CatSurface0}" Margin="0,0,0,20">
                        <StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,16">
                                <materialDesign:PackIcon Kind="CodeBraces" Foreground="{DynamicResource CatMauve}" VerticalAlignment="Center" Width="24" Height="24"/>
                                <TextBlock Text="Cursor" Style="{DynamicResource HeaderStyle}" FontSize="18" Margin="12,0,0,0" VerticalAlignment="Center"/>
                            </StackPanel>

                            <StackPanel Orientation="Horizontal" Margin="0,0,0,16">
                                <Button Content="Auto-Detect Session" Command="{Binding AutoDetectCursorCommand}" 
                                        Style="{DynamicResource AuthActionButton}" Foreground="{DynamicResource CatMauve}"
                                        ToolTip="Scans browser cookies for cursor.com"/>
                                <Button Content="Authorize via Browser (OAuth Flow)" Command="{Binding OpenCursorUrlCommand}" 
                                        Style="{DynamicResource AuthActionButton}" Foreground="{DynamicResource CatSubtext}" 
                                        Margin="12,0,0,0"/>
                            </StackPanel>

                            <TextBox Style="{DynamicResource PremiumTextBox}"
                                     materialDesign:HintAssist.Hint="Cursor Token (WorkosCursorSessionToken=...)" 
                                     Text="{Binding CursorCookie}" 
                                     materialDesign:TextFieldAssist.UnderlineBrush="{DynamicResource CatMauve}"/>
                        </StackPanel>
                    </materialDesign:Card>

                    <!-- GitHub Copilot -->
                    <materialDesign:Card Padding="24" UniformCornerRadius="12" Background="{DynamicResource CatSurface0}" Margin="0,0,0,20">
                        <StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,16">
                                <materialDesign:PackIcon Kind="Github" Foreground="{DynamicResource CatPeach}" VerticalAlignment="Center" Width="24" Height="24"/>
                                <TextBlock Text="GitHub Copilot" Style="{DynamicResource HeaderStyle}" FontSize="18" Margin="12,0,0,0" VerticalAlignment="Center"/>
                            </StackPanel>

                            <StackPanel Orientation="Horizontal" Margin="0,0,0,16">
                                <Button Content="Authorize via Browser (OAuth Flow)" Command="{Binding LoginCopilotCommand}" 
                                        Style="{DynamicResource MaterialDesignRaisedButton}" 
                                        Background="{DynamicResource CatPeach}"
                                        Foreground="{DynamicResource CatBase}"
                                        Padding="20,0" Height="36" FontWeight="Bold"
                                        ToolTip="Uses GitHub Device Flow (OAuth)"/>
                            </StackPanel>

                            <!-- Hero Code Display -->
                            <Border Background="{DynamicResource CatMantle}" CornerRadius="8" Margin="0,0,0,16" Padding="16"
                                    Visibility="{Binding AuthCode, Converter={StaticResource StringToVisibilityConverter}}">
                                <StackPanel HorizontalAlignment="Center">
                                    <TextBlock Text="ENTER THIS CODE ON GITHUB" FontSize="11" FontWeight="Black" Foreground="{DynamicResource CatSubtext}" HorizontalAlignment="Center"/>
                                    <TextBlock Text="{Binding AuthCode}" FontSize="42" FontWeight="Black" Foreground="{DynamicResource CatPeach}" HorizontalAlignment="Center" Margin="0,4"/>
                                    <Button Content="Copy Authorization Code" Click="CopyAuthCode_Click" Style="{DynamicResource MaterialDesignFlatButton}" 
                                            Foreground="{DynamicResource CatSubtext}" FontSize="12" Height="28" Padding="12,0"/>
                                </StackPanel>
                            </Border>

                            <TextBox Style="{DynamicResource PremiumTextBox}"
                                     materialDesign:HintAssist.Hint="GitHub API Token (ghp_...)" 
                                     Text="{Binding CopilotToken}" 
                                     materialDesign:TextFieldAssist.UnderlineBrush="{DynamicResource CatPeach}"/>
                        </StackPanel>
                    </materialDesign:Card>

                    <!-- OpenAI / ChatGPT -->
                    <materialDesign:Card Padding="24" UniformCornerRadius="12" Background="{DynamicResource CatSurface0}" Margin="0,0,0,20">
                        <StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,16">
                                <materialDesign:PackIcon Kind="CircleMultipleOutline" Foreground="{DynamicResource CatGreen}" VerticalAlignment="Center" Width="24" Height="24"/>
                                <TextBlock Text="OpenAI / ChatGPT" Style="{DynamicResource HeaderStyle}" FontSize="18" Margin="12,0,0,0" VerticalAlignment="Center"/>
                            </StackPanel>

                            <StackPanel Orientation="Horizontal" Margin="0,0,0,16">
                                <Button Content="Auto-Detect Session" Command="{Binding AutoDetectChatGPTCommand}" 
                                        Style="{DynamicResource AuthActionButton}" Foreground="{DynamicResource CatGreen}"
                                        ToolTip="Scans browser cookies for chatgpt.com &amp; openai.com"/>
                                <Button Content="Authorize via Browser (OAuth Flow)" Command="{Binding OpenChatGPTUrlCommand}" 
                                        Style="{DynamicResource AuthActionButton}" Foreground="{DynamicResource CatSubtext}" 
                                        Margin="12,0,0,0"/>
                            </StackPanel>

                            <TextBox Style="{DynamicResource PremiumTextBox}"
                                     materialDesign:HintAssist.Hint="Session Token (__Secure-next-auth.session-token=...)" 
                                     Text="{Binding ChatgptCookie}" 
                                     materialDesign:TextFieldAssist.UnderlineBrush="{DynamicResource CatGreen}"/>
                        </StackPanel>
                    </materialDesign:Card>
                </StackPanel>
            </Border>
        </ScrollViewer>

        <!-- Footer Actions -->
        <Border Grid.Row="2" Background="{DynamicResource CatMantle}" Padding="24,16" BorderBrush="{DynamicResource CatSurface0}" BorderThickness="0,1,0,0">
            <Grid>
                <TextBlock Text="{Binding StatusMessage}" VerticalAlignment="Center" 
                           Foreground="{DynamicResource CatSubtext}" FontStyle="Italic" FontSize="12"/>
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                    <Button Content="Auto-Detect" Command="{Binding AutoDetectCommand}" Margin="0,0,12,0"
                            Style="{DynamicResource MaterialDesignOutlinedButton}" 
                            Foreground="{DynamicResource CatBlue}" BorderBrush="{DynamicResource CatBlue}"/>
                    <Button Content="Save Credentials" Command="{Binding SaveTokensCommand}"
                            Background="{DynamicResource CatBlue}" Foreground="{DynamicResource CatBase}" 
                            FontWeight="Bold" BorderThickness="0" Padding="16,0"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Window>
