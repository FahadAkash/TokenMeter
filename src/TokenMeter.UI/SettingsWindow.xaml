<Window x:Class="TokenMeter.UI.SettingsWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        xmlns:converters="clr-namespace:TokenMeter.UI.Converters"
        Title="Settings &amp; Authentication" Width="600" Height="550"
        WindowStartupLocation="CenterOwner"
        Background="{DynamicResource CatBase}"
        FontFamily="Segoe UI Variable Text, Segoe UI">

    <Window.Resources>
        <!-- Converter now comes from App.xaml -->
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="60"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Premium Header Area -->
        <Border Grid.Row="0" Background="{DynamicResource CatMantle}" BorderBrush="{DynamicResource CatSurface0}" BorderThickness="0,0,0,1">
            <Grid Margin="24,0">
                <StackPanel VerticalAlignment="Center">
                    <TextBlock Text="Settings &amp; Authentication" FontWeight="Bold" Foreground="{DynamicResource CatText}" FontSize="16"/>
                    <TextBlock Text="Configure your AI provider tokens" Foreground="{DynamicResource CatSubtext}" FontSize="11"/>
                </StackPanel>
                <Button HorizontalAlignment="Right" VerticalAlignment="Center" 
                        Background="Transparent" BorderThickness="0" Width="32" Height="32" 
                        Click="CloseButton_Click" Content="âœ•" Foreground="{DynamicResource CatSubtext}"
                        FontSize="18" Padding="0"/>
            </Grid>
        </Border>

        <!-- Main Settings Content -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
            <Border Padding="24">
                <StackPanel>
                    <TextBlock Text="Manual Token Entry" Style="{DynamicResource HeaderStyle}" FontSize="18" Margin="0,0,0,4"/>
                    <TextBlock Text="Paste browser cookies or API tokens below. Use the Auto-Detect button below to try gathering them automatically." 
                               Style="{DynamicResource SubtextStyle}" Margin="0,0,0,24" TextWrapping="Wrap"/>

                    <ItemsControl ItemsSource="{Binding ProviderSettings}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <materialDesign:Card Padding="24" UniformCornerRadius="12" Background="{DynamicResource CatSurface0}" Margin="0,0,0,20">
                                    <StackPanel>
                                        <StackPanel Orientation="Horizontal" Margin="0,0,0,16">
                                            <materialDesign:PackIcon Kind="{Binding IconKind}" Foreground="{Binding ColorHex, Converter={StaticResource HexToBrushConverter}}" VerticalAlignment="Center" Width="24" Height="24"/>
                                            <TextBlock Text="{Binding DisplayName}" Style="{DynamicResource HeaderStyle}" FontSize="18" Margin="12,0,0,0" VerticalAlignment="Center"/>
                                        </StackPanel>

                                        <!-- Generic Auto Detect / Browser Auth -->
                                        <StackPanel Orientation="Horizontal" Margin="0,0,0,16">
                                            <Button Content="Auto-Detect Session" 
                                                    Command="{Binding DataContext.AutoDetectProviderCommand, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                    CommandParameter="{Binding ProviderId}"
                                                    Style="{DynamicResource AuthActionButton}" 
                                                    Foreground="{Binding ColorHex, Converter={StaticResource HexToBrushConverter}}"
                                                    ToolTip="Scans browser cookies for this provider"/>
                                            <Button Content="Authorize via Browser / External" 
                                                    Command="{Binding DataContext.OpenProviderUrlCommand, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                    CommandParameter="{Binding ProviderId, Converter={StaticResource ProviderToUrlConverter}}"
                                                    Style="{DynamicResource AuthActionButton}" 
                                                    Foreground="{DynamicResource CatSubtext}" 
                                                    Margin="12,0,0,0"/>
                                        </StackPanel>

                                        <!-- Dynamic Settings Fields -->
                                        <ItemsControl ItemsSource="{Binding Settings}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <ContentControl>
                                                        <ContentControl.Style>
                                                            <Style TargetType="ContentControl">
                                                                <Style.Triggers>
                                                                    <!-- Picker -->
                                                                    <DataTrigger Binding="{Binding IsPicker}" Value="True">
                                                                        <Setter Property="ContentTemplate">
                                                                            <Setter.Value>
                                                                                <DataTemplate>
                                                                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
                                                                                        <TextBlock Text="{Binding Definition.DisplayName}" VerticalAlignment="Center" Width="120" Foreground="{DynamicResource CatSubtext}"/>
                                                                                        <ComboBox SelectedValue="{Binding Value}" ItemsSource="{Binding Definition.Options}" Width="160"/>
                                                                                    </StackPanel>
                                                                                </DataTemplate>
                                                                            </Setter.Value>
                                                                        </Setter>
                                                                    </DataTrigger>
                                                                    <!-- SecretField -->
                                                                    <DataTrigger Binding="{Binding IsSecretField}" Value="True">
                                                                        <Setter Property="ContentTemplate">
                                                                            <Setter.Value>
                                                                                <DataTemplate>
                                                                                    <TextBox Style="{DynamicResource PremiumTextBox}"
                                                                                             materialDesign:HintAssist.Hint="{Binding Definition.DisplayName}" 
                                                                                             Text="{Binding Value, UpdateSourceTrigger=PropertyChanged}" 
                                                                                             materialDesign:TextFieldAssist.UnderlineBrush="{Binding DataContext.ColorHex, RelativeSource={RelativeSource AncestorType=ItemsControl, AncestorLevel=2}, Converter={StaticResource HexToBrushConverter}}"/>
                                                                                </DataTemplate>
                                                                            </Setter.Value>
                                                                        </Setter>
                                                                    </DataTrigger>
                                                                    <!-- TextField -->
                                                                    <DataTrigger Binding="{Binding IsTextField}" Value="True">
                                                                        <Setter Property="ContentTemplate">
                                                                            <Setter.Value>
                                                                                <DataTemplate>
                                                                                    <TextBox Style="{DynamicResource PremiumTextBox}"
                                                                                             materialDesign:HintAssist.Hint="{Binding Definition.DisplayName}" 
                                                                                             Text="{Binding Value, UpdateSourceTrigger=PropertyChanged}"/>
                                                                                </DataTemplate>
                                                                            </Setter.Value>
                                                                        </Setter>
                                                                    </DataTrigger>
                                                                    <!-- Toggle -->
                                                                    <DataTrigger Binding="{Binding IsToggle}" Value="True">
                                                                        <Setter Property="ContentTemplate">
                                                                            <Setter.Value>
                                                                                <DataTemplate>
                                                                                    <CheckBox Content="{Binding Definition.DisplayName}" IsChecked="{Binding ToggleValue, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,0,12" />
                                                                                </DataTemplate>
                                                                            </Setter.Value>
                                                                        </Setter>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </ContentControl.Style>
                                                    </ContentControl>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </StackPanel>
                                </materialDesign:Card>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </Border>
        </ScrollViewer>

        <!-- Footer Actions -->
        <Border Grid.Row="2" Background="{DynamicResource CatMantle}" Padding="24,16" BorderBrush="{DynamicResource CatSurface0}" BorderThickness="0,1,0,0">
            <Grid>
                <TextBlock Text="{Binding StatusMessage}" VerticalAlignment="Center" 
                           Foreground="{DynamicResource CatSubtext}" FontStyle="Italic" FontSize="12"/>
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                    <Button Content="Auto-Detect" Command="{Binding AutoDetectCommand}" Margin="0,0,12,0"
                            Style="{DynamicResource MaterialDesignOutlinedButton}" 
                            Foreground="{DynamicResource CatBlue}" BorderBrush="{DynamicResource CatBlue}"/>
                    <Button Content="Save Credentials" Command="{Binding SaveTokensCommand}"
                            Background="{DynamicResource CatBlue}" Foreground="{DynamicResource CatBase}" 
                            FontWeight="Bold" BorderThickness="0" Padding="16,0"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Window>
